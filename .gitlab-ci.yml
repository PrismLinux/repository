image: archlinux:latest

variables:
  REPO_NAME: "prismlinux"
  ARCH: "x86_64"
  REPO_DIR: "public"
  CACHE_DIR: "cache"
  CHECKSUMS_FILE: "package_checksums.txt"
  REMOTE_PACKAGES_FILE: "remote_packages.json"
  REBUILD_TRIGGER_FILE: "rebuild_packages.txt"
  PACKAGES_CONFIG: "packages.txt"
  STORAGE_DRIVER: "overlay"
  PODMAN_SYSTEMD_UNIT: "podman.socket"

before_script:
  # Update system and install dependencies
  - pacman -Syu --noconfirm
  - pacman -S --noconfirm podman podman-docker podman-compose python python-pip
  - podman info
  - podman-compose version
  # Start Podman socket for rootless operation
  - systemctl --user start podman.socket
  - export DOCKER_HOST=unix:///run/user/$UID/podman/podman.sock

stages:
  - validate
  - check
  - build
  - deploy

validate_config:
  stage: validate
  script:
    - podman-compose -f compose.yml up --build --exit-code-from repo_builder
    - cat public/rebuild_needed.txt
  artifacts:
    paths:
      - cache/
      - public/
      - remote_packages.json
      - rebuild_packages.txt
      - package_checksums.txt
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_PIPELINE_SOURCE == 'web'
    - if: $FORCE_REBUILD == "true"

check_package_updates:
  stage: check
  needs:
    - job: validate_config
      artifacts: true
  script:
    - podman-compose -f compose.yml up --build --exit-code-from repo_builder
    - cat public/rebuild_needed.txt
  artifacts:
    paths:
      - cache/
      - public/
      - remote_packages.json
      - rebuild_packages.txt
      - package_checksums.txt
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_PIPELINE_SOURCE == 'web'
    - if: $FORCE_REBUILD == "true"

build_repository:
  stage: build
  needs:
    - job: check_package_updates
      artifacts: true
  script:
    - if [ "$(cat public/rebuild_needed.txt)" = "true" ] || [ "$FORCE_REBUILD" = "true" ]; then
      podman-compose -f compose.yml up --build --exit-code-from repo_builder;
      else
      echo "No rebuild needed, skipping build stage.";
      fi
  artifacts:
    paths:
      - public/
      - cache/
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_PIPELINE_SOURCE == 'web'
    - if: $FORCE_REBUILD == "true"

pages:
  stage: deploy
  needs:
    - job: build_repository
      artifacts: true
  script:
    - podman-compose -f compose.yml up --build --exit-code-from repo_builder
    - cp -r public/* .
  artifacts:
    paths:
      - public
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $FORCE_REBUILD == "true"
