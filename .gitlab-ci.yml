image: archlinux:latest

stages:
  - build
  - release

build_package:
  stage: build
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
  before_script:
    - pacman -Syu --noconfirm
    - pacman -S --noconfirm base-devel sudo
  script:
    - echo "Customizing /etc/makepkg.conf to disable debug packages..."
    - sed -i "s/^OPTIONS=.*/OPTIONS=(!strip !debug)/" /etc/makepkg.conf
    - useradd -m builder
    - |
      echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
    - chown -R builder:builder .
    - sudo -u builder makepkg -sfc --noconfirm
  artifacts:
    paths:
      - "*.pkg.tar.zst"
    expire_in: 1 hour

create_release_with_upload:
  stage: release
  image: registry.gitlab.com/gitlab-org/cli:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"'
  needs:
    - job: build_package
      artifacts: true
  script:
    - apk add --no-cache bash
    - bash -c 'source PKGBUILD && echo "VERSION=${pkgver}-${pkgrel}" > version.env'
    - source version.env

    - |
      echo "Version found in PKGBUILD: v${VERSION}"
    - TAG_NAME="v${VERSION}"
    - |
      if glab release view "${TAG_NAME}" >/dev/null 2>&1; then
        echo "Release for tag ${TAG_NAME} already exists. Nothing to do."
        exit 0
      else
        echo "Release for tag ${TAG_NAME} not found. Proceeding to create it."
      fi

    - PKG_FILE=$(find . -name "*.pkg.tar.zst")
    - |
      echo "Package file found: $PKG_FILE"

    #    Create the release and UPLOAD the file.
    - |
      glab release create "${TAG_NAME}" "$PKG_FILE" \
        --name "Release ${TAG_NAME}" \
        --notes "Release for version ${VERSION}"
    - echo "Successfully created release and tag ${TAG_NAME} with uploaded asset."
