# Copyright (C) 2025 CrystalNetwork Studio
#
# This file is part of the CrystalNetwork Studio CrystalLinux Repository.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.

image: archlinux:latest

variables:
  REPO_NAME: "crystallinux"
  REPO_DIR: "public"
  PACKAGE_PROJECT_IDS: "70724583"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == 'push'

# --- Cache ---
# Caches the repository contents to avoid re-downloading packages that haven't changed.
cache:
  key: "repo-cache-${CI_COMMIT_REF_SLUG}"
  paths:
    - "${REPO_DIR}/"
  policy: pull-push

pages:
  stage: deploy
  
  before_script:
    - pacman -Syu --noconfirm
    - pacman -S --noconfirm curl jq base-devel git
  
  script:
    - |
      set -eo pipefail # Exit on any error
      REPO_ARCH_DIR="${REPO_DIR}/x86_64"
      mkdir -p "${REPO_ARCH_DIR}"
      echo "Repository directory is ${REPO_ARCH_DIR}"
      echo "Initial contents from cache:"
      ls -R "${REPO_DIR}"

      # --- Step 1: Get a list of ALL expected remote packages from releases ---
      declare -A remote_packages_map # Use an associative array for efficient lookups
      echo "Fetching list of all available remote packages from releases..."
      
      for project_id in $PACKAGE_PROJECT_IDS; do
        echo "--> Checking project ID: ${project_id}"
        
        # Get the latest release
        RELEASES_API_URL="https://gitlab.com/api/v4/projects/${project_id}/releases"
        LATEST_RELEASE=$(curl --silent --show-error --header "PRIVATE-TOKEN: $GITLAB_TOKEN" "$RELEASES_API_URL" | jq -r '.[0]')
        
        if [ "$LATEST_RELEASE" = "null" ]; then
          echo "WARNING: No releases found for project ${project_id}. Skipping."
          continue
        fi
        
        # Extract release tag and assets
        RELEASE_TAG=$(echo "$LATEST_RELEASE" | jq -r '.tag_name')
        echo "Found latest release: ${RELEASE_TAG}"
        
        # Get release assets (links)
        RELEASE_ASSETS=$(echo "$LATEST_RELEASE" | jq -r '.assets.links[]?')
        
        if [ -z "$RELEASE_ASSETS" ]; then
          echo "WARNING: No assets found in release ${RELEASE_TAG}. Skipping."
          continue
        fi
        
        # Process each asset link
        while IFS= read -r asset; do
          if [ -z "$asset" ]; then continue; fi
          
          ASSET_URL=$(echo "$asset" | jq -r '.url')
          ASSET_NAME=$(echo "$asset" | jq -r '.name')
          
          # Check if it's a package file
          if [[ "$ASSET_NAME" == *.pkg.tar.zst ]]; then
            echo "Found remote package: ${ASSET_NAME}"
            remote_packages_map["${ASSET_NAME}"]="${ASSET_URL}"
          fi
        done <<< "$(echo "$LATEST_RELEASE" | jq -c '.assets.links[]?')"
      done
      echo "Total unique remote packages found: ${#remote_packages_map[@]}"
      
      # --- Step 2: Sync local repository with remote list ---
      REPO_UPDATED=false
      
      # 2a: Remove orphaned packages
      echo "Checking for orphaned packages in local repository..."
      for local_pkg_path in "${REPO_ARCH_DIR}"/*.pkg.tar.zst; do
        [ -f "$local_pkg_path" ] || continue
        local_pkg_filename=$(basename "$local_pkg_path")
        if [[ ! -v remote_packages_map["${local_pkg_filename}"] ]]; then
          echo "  -> Removing orphaned package: ${local_pkg_filename}"
          rm "$local_pkg_path"
          REPO_UPDATED=true
        fi
      done
      
      # 2b: Download new or updated packages
      echo "Checking for new packages to download..."
      for pkg_filename in "${!remote_packages_map[@]}"; do
        if [ ! -f "${REPO_ARCH_DIR}/${pkg_filename}" ]; then
          echo "  -> Downloading new package: ${pkg_filename}"
          DOWNLOAD_URL="${remote_packages_map[$pkg_filename]}"
          
          # Download the package with proper error handling
          if curl --location --silent --show-error --fail --header "PRIVATE-TOKEN: $GITLAB_TOKEN" --output "${REPO_ARCH_DIR}/${pkg_filename}" "${DOWNLOAD_URL}"; then
            echo "    Successfully downloaded: ${pkg_filename}"
            REPO_UPDATED=true
          else
            echo "    ERROR: Failed to download ${pkg_filename} from ${DOWNLOAD_URL}"
            # Remove partial file if it exists
            rm -f "${REPO_ARCH_DIR}/${pkg_filename}"
          fi
        else
          echo "  -> Package already exists in cache: ${pkg_filename}"
        fi
      done
      
      # --- Step 3: Update repository database ---
      cd "${REPO_ARCH_DIR}"
      
      if ! ls ./*.pkg.tar.zst 1> /dev/null 2>&1; then
        echo "Repository is empty after sync. Clearing any old database files."
        rm -f ${REPO_NAME}.*
        REPO_UPDATED=false
      fi

      if [ "$REPO_UPDATED" = true ]; then
        echo "Repository was updated. Rebuilding database..."
        rm -f ${REPO_NAME}.*
        repo-add "${REPO_NAME}.db.tar.gz" *.pkg.tar.zst
      else
        echo "No changes detected. Using database from cache."
        # Ensure database files exist even if no updates
        if [ ! -f "${REPO_NAME}.db.tar.gz" ] && ls ./*.pkg.tar.zst 1> /dev/null 2>&1; then
          echo "Database missing but packages exist. Rebuilding database..."
          repo-add "${REPO_NAME}.db.tar.gz" *.pkg.tar.zst
        fi
      fi
      
      # --- Step 4: CRITICAL FIX FOR GITLAB PAGES (403 ERROR) ---
      echo "Ensuring database files are compatible with static hosting..."
      if [ -f "${REPO_NAME}.db.tar.gz" ]; then
        # Create symbolic links instead of copies for GitLab Pages compatibility
        rm -f "${REPO_NAME}.db" "${REPO_NAME}.files"
        ln -sf "${REPO_NAME}.db.tar.gz" "${REPO_NAME}.db"
        ln -sf "${REPO_NAME}.files.tar.gz" "${REPO_NAME}.files"
        
        echo "Database files are correctly formatted with symbolic links."
        echo "Files in repository:"
        ls -la ${REPO_NAME}.*
      else
        echo "No packages in repository. Creating empty database files."
        # Create empty tar.gz files for consistency
        echo -n | gzip > "${REPO_NAME}.db.tar.gz"
        echo -n | gzip > "${REPO_NAME}.files.tar.gz"
        ln -sf "${REPO_NAME}.db.tar.gz" "${REPO_NAME}.db"
        ln -sf "${REPO_NAME}.files.tar.gz" "${REPO_NAME}.files"
      fi
      
      # Create .htaccess file for Apache compatibility (GitLab Pages)
      cat > .htaccess << 'EOF'
      # Enable access to database files
      <Files "crystallinux.db">
          Header set Content-Type "application/octet-stream"
          Header set Content-Disposition "attachment"
      </Files>
      <Files "crystallinux.files">
          Header set Content-Type "application/octet-stream" 
          Header set Content-Disposition "attachment"
      </Files>
      EOF
      
      # --- Step 5: Return to root and create configuration files ---
      cd ../.. # Return to project root ($CI_PROJECT_DIR)
      
      # Create index.html
      cat > "${REPO_DIR}/index.html" << 'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>CrystalLinux Repository</title>
          <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              .container { max-width: 800px; margin: 0 auto; }
              .code { background: #f4f4f4; padding: 10px; border-radius: 5px; font-family: monospace; }
              .links { margin: 20px 0; }
              .links a { display: inline-block; margin: 5px 10px 5px 0; padding: 8px 15px; background: #007acc; color: white; text-decoration: none; border-radius: 3px; }
              .links a:hover { background: #005999; }
          </style>
      </head>
      <body>
          <div class="container">
              <h1>CrystalLinux Repository</h1>
              <p>Arch Linux compatible package repository for CrystalLinux distribution.</p>
              
              <div class="links">
                  <a href="README.md">Installation Instructions</a>
                  <a href="crystallinux-repo.conf">Pacman Config</a>
              </div>
              
              <h2>Quick Setup</h2>
              <p>Add the following to your <code>/etc/pacman.conf</code>:</p>
              <div class="code">
      [crystallinux]<br>
      Server = https://crystalnetwork-studio.gitlab.io/linux/CrystalLinux/repository/pkgbuilds/gitlab-profile/$arch<br>
      SigLevel = Optional TrustAll
              </div>
              
              <p>Then run:</p>
              <div class="code">sudo pacman -Sy</div>
          </div>
      </body>
      </html>
      EOF
      
      # Create pacman configuration snippet for users
      cat > "${REPO_DIR}/crystallinux-repo.conf" << 'EOF'
      # Add this to your /etc/pacman.conf
      [crystallinux]
      Server = https://crystalnetwork-studio.gitlab.io/linux/CrystalLinux/repository/pkgbuilds/gitlab-profile/$arch
      SigLevel = Optional TrustAll
      EOF
            
      # Create installation instructions
      cat > "${REPO_DIR}/README.md" << 'EOF'
      # CrystalLinux Repository

      ## Installation

      Add the following to your `/etc/pacman.conf`:

      ```
      [crystallinux]
      Server = https://crystalnetwork-studio.gitlab.io/linux/CrystalLinux/repository/pkgbuilds/gitlab-profile/$arch
      SigLevel = Optional TrustAll
      ```

      Then run:
      ```bash
      sudo pacman -Sy
      ```

      ## Available Packages

      - Database files: [crystallinux.db.tar.gz](x86_64/crystallinux.db.tar.gz), [crystallinux.files.tar.gz](x86_64/crystallinux.files.tar.gz)

      ## Manual Database Access

      If you encounter 403 errors, you can access the database files directly:
      - Database: https://crystalnetwork-studio.gitlab.io/linux/CrystalLinux/repository/pkgbuilds/gitlab-profile/x86_64/crystallinux.db.tar.gz
      - Files: https://crystalnetwork-studio.gitlab.io/linux/CrystalLinux/repository/pkgbuilds/gitlab-profile/x86_64/crystallinux.files.tar.gz

      ## Troubleshooting

      If pacman returns 403 errors when accessing the database, try:

      1. Clear pacman cache: `sudo pacman -Scc`
      2. Update package lists: `sudo pacman -Sy`
      3. Use direct .tar.gz URLs in your pacman configuration

      ### Alternative Configuration

      If you continue to have issues, you can configure pacman to use the .tar.gz files directly by creating a custom configuration:

      ```bash
      sudo tee /etc/pacman.d/crystallinux.conf << 'EOFCONFIG'
      [crystallinux]
      Server = https://crystalnetwork-studio.gitlab.io/linux/CrystalLinux/repository/pkgbuilds/gitlab-profile/$arch
      SigLevel = Optional TrustAll
      EOFCONFIG
      ```

      Then include it in your main `/etc/pacman.conf`:
      ```
      Include = /etc/pacman.d/crystallinux.conf
      ```
      EOF

      # --- Step 6: FINAL DEBUGGING STEP ---
      echo "-----------------------------------------"
      echo "Final check before artifact upload:"
      echo "Current directory: $(pwd)"
      echo "Listing all files recursively..."
      ls -laR
      echo "-----------------------------------------"

  artifacts:
    paths:
      - public