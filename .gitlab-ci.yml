# Copyright (C) 2025 CrystalNetwork Studio
#
# This file is part of the CrystalNetwork Studio, PrismLinux Repository.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program. If not, see <https://www.gnu.org/licenses/>.

image: archlinux:latest

variables:
  REPO_NAME: "prismlinux"
  REPO_DIR: "public"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == 'schedule'
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PIPELINE_SOURCE == 'push'
    - if: ($CI_PIPELINE_SOURCE == 'push' || $CI_PIPELINE_SOURCE == 'merge_request_event')
      changes:
        - .gitlab-ci.yml
        - packages_id.txt
        - remote_packages.txt

cache:
  key: "repo-cache-${CI_COMMIT_REF_SLUG}"
  paths:
    - "${REPO_DIR}/x86_64/"
  policy: pull-push

pages:
  stage: deploy
  pages: true

  before_script:
    - pacman -Syu --noconfirm
    - pacman -S --noconfirm curl jq base-devel git go
    - go version

  script: |
    set -eo pipefail

    echo "Building package manager..."
    go build -o package-manager .

    echo "Running package manager with commit enabled..."
    ./package-manager --commit

    echo "Package management completed successfully."

    echo "-----------------------------------------"
    echo "Final check before artifact upload:"
    ls -laR public
    echo "-----------------------------------------"

  artifacts:
    paths:
      - public
